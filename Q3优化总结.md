# Q3Solver_v3.py 时间限制优化总结

## 问题分析
原始Q3Solver_v3.py会一直运行不停，导致计算时间过长，需要添加时间和评估次数限制。

## 主要优化措施

### 1. 时间和评估限制
- **时间限制**: 默认30分钟 (`--max_time_minutes 30.0`)
- **评估限制**: 默认10000次评估 (`--max_evaluations 10000`)
- **实时检查**: 在各个阶段都会检查是否超限并及时停止

### 2. 参数优化（减少计算量）

#### 内部评估参数
- **时间步长**: dt从0.003→0.005 (减少40%计算点)
- **采样密度**: nphi从360→240, nz从7→5 (减少52%采样点)
- **工作线程**: 限制为最多4个 (避免资源争抢)
- **块大小**: chunk从900→600, block从4096→2048 (减少内存使用)

#### Stage1搜索空间
- **航向角**: 范围从±2.0°→±1.5°, 步长从0.5°→0.75°
- **速度**: 步长从10→20 m/s (减少50%速度选项)
- **时间参数**: 各时间步长都增大50-100%
- **引信**: 范围从3-8s→3-7s, 步长从1→2s

#### Stage2精修
- **候选数**: topk从20→10
- **搜索范围**: span_steps从2→1 (减少81%邻域)
- **最大候选**: 从20000→5000 (减少75%)

### 3. 限制检查机制

```python
def check_limits():
    elapsed_time = time.time() - start_time
    if elapsed_time > max_time_seconds:
        return True  # 超时停止
    if eval_counter[0] >= args.max_evaluations:
        return True  # 超评估次数停止
    return False
```

### 4. 各阶段限制检查
- **Stage1前**: 检查是否已超限
- **Stage1后**: 如超限则保存结果并退出
- **Stage2前**: 检查限制，超限则跳过
- **坐标下降前**: 检查限制，超限则跳过

## 预期效果

### 计算量减少
- **总候选数**: 约减少70-80%
- **采样点**: 减少52%
- **时间步**: 减少40%
- **搜索空间**: 减少60-75%

### 运行时间控制
- **默认限制**: 30分钟或10000次评估
- **快速模式**: 15分钟或5000次评估 (runQ3_fast.bat)
- **自动停止**: 超限时自动保存结果并退出

## 使用方法

### 标准模式 (30分钟限制)
```bash
python Q3Solver_v3.py
```

### 快速模式 (15分钟限制)
```bash
runQ3_fast.bat
```

### 自定义限制
```bash
python Q3Solver_v3.py --max_time_minutes 20 --max_evaluations 8000
```

### 超快速测试 (5分钟)
```bash
python Q3Solver_v3.py --max_time_minutes 5 --max_evaluations 2000 --dt 0.01 --nphi 120 --nz 3
```

## 输出改进

### 运行信息
- 显示时间和评估限制
- 实时报告已用时间和评估次数
- 超限时显示停止原因

### 结果保存
- 即使超限也会保存当前最佳结果
- 完整的收敛曲线图
- 详细的运行统计信息

## 技术特点

1. **渐进式优化**: 即使提前停止也能得到合理结果
2. **资源控制**: 限制线程数和内存使用
3. **智能跳过**: 超限时跳过后续阶段但保留结果
4. **完整输出**: 无论何时停止都会生成完整的Excel和图表

这个优化版本确保Q3求解器在合理时间内完成，避免无限运行的问题。
